<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Bank Statements - Apartment Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">Apartment Mgmt</a>
            <div class="navbar-nav ms-auto">
                <span id="userInfo" class="nav-link text-light"></span>
                <a href="#" onclick="logout()" class="nav-link text-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Import Bank Statements (CSV / Excel)</h2>
        <div class="card shadow">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select Bank Statement File (CSV or Excel)</label>
                    <input type="file" id="bankFile" accept=".csv,.xlsx,.xls" class="form-control" onchange="handleFileSelect(event)">
                </div>
                <button onclick="importToAccounts()" id="importBtn" class="btn btn-success" disabled>Import to Accounts</button>
                <button onclick="clearPreview()" class="btn btn-secondary ms-2">Clear Preview</button>
            </div>
        </div>

        <h4 class="mt-5">Preview</h4>
        <div class="table-responsive" style="max-height: 500px; overflow:auto;">
            <table class="table table-striped table-hover" id="previewTable">
                <thead class="table-dark"><tr id="previewHead"></tr></thead>
                <tbody id="previewBody"></tbody>
            </table>
        </div>
        <p id="previewInfo" class="text-muted"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let importedRows = [];
        let currentFileName = '';

        function checkAuth() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!user) window.location.href = 'login.html';
            document.getElementById('userInfo').textContent = `${user.username} (${user.role})`;
        }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        function getData(key) { return JSON.parse(localStorage.getItem(key)) || []; }
        function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            currentFileName = file.name;

            const reader = new FileReader();
            const isCSV = file.name.toLowerCase().endsWith('.csv');

            if (isCSV) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }

            reader.onload = function(ev) {
                let workbook;
                if (isCSV) {
                    workbook = XLSX.read(ev.target.result, { type: 'string' });
                } else {
                    workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                }

                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                importedRows = XLSX.utils.sheet_to_json(worksheet, { header: true, defval: "", blankrows: false });

                renderPreview();
                document.getElementById('importBtn').disabled = false;
            };
        }

        function renderPreview() {
            if (!importedRows.length) return;
            const headers = Object.keys(importedRows[0]);
            let headHTML = '';
            headers.forEach(h => headHTML += `<th>${h}</th>`);
            document.getElementById('previewHead').innerHTML = headHTML;

            let bodyHTML = '';
            importedRows.forEach(row => {
                let rowHTML = '<tr>';
                headers.forEach(h => {
                    rowHTML += `<td>${row[h] !== undefined && row[h] !== null ? row[h] : ''}</td>`;
                });
                rowHTML += '</tr>';
                bodyHTML += rowHTML;
            });
            document.getElementById('previewBody').innerHTML = bodyHTML;
            document.getElementById('previewInfo').textContent = `${importedRows.length} rows loaded from ${currentFileName}`;
        }

        function importToAccounts() {
            if (!importedRows.length) return;
            const transactions = getData('transactions');
            let addedCount = 0;

            importedRows.forEach(row => {
                // Flexible column mapping (common bank statement column names)
                let dateStr = row.Date || row['Txn Date'] || row['Transaction Date'] || row.date || row['Date '] || '';
                let desc = row.Narration || row.Description || row.Particulars || row['Details'] || row['Description '] || 'Bank Import';
                let debit = parseFloat(row.Debit || row.debit || row.Dr || row['Dr Amount'] || 0) || 0;
                let credit = parseFloat(row.Credit || row.credit || row.Cr || row['Cr Amount'] || 0) || 0;

                const amount = debit > 0 ? debit : credit;
                const type = debit > 0 ? 'debit' : (credit > 0 ? 'credit' : null);

                if (amount > 0 && dateStr && type) {
                    transactions.push({
                        id: Date.now() + addedCount,
                        date: dateStr,
                        description: desc,
                        amount: amount,
                        type: type,
                        category: 'Bank Statement Import'
                    });
                    addedCount++;
                }
            });

            saveData('transactions', transactions);
            alert(`âœ… Successfully imported ${addedCount} transactions from ${currentFileName}`);
            clearPreview();
        }

        function clearPreview() {
            importedRows = [];
            document.getElementById('previewHead').innerHTML = '';
            document.getElementById('previewBody').innerHTML = '';
            document.getElementById('previewInfo').textContent = '';
            document.getElementById('importBtn').disabled = true;
            document.getElementById('bankFile').value = '';
        }

        window.onload = () => {
            checkAuth();
        };
    </script>
</body>
</html>