<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Bank - Apartment Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Navbar same -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">Apartment Mgmt</a>
            <div class="navbar-nav ms-auto">
                <span id="userInfo" class="nav-link text-light"></span>
                <a href="#" onclick="logout()" class="nav-link text-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Import Bank Statements (CSV/Excel)</h2>
        <input type="file" id="bankFile" accept=".csv,.xlsx,.xls" class="form-control mb-3" onchange="handleFileSelect(event)">
        <button onclick="importToAccounts()" id="importBtn" class="btn btn-success" disabled>Import to Accounts</button>

        <h4 class="mt-4">Preview</h4>
        <table class="table table-striped" id="previewTable">
            <thead id="previewHead"></thead>
            <tbody id="previewBody"></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'login.html';
        document.getElementById('userInfo').textContent = `${sessionStorage.getItem('username')} (${sessionStorage.getItem('role')})`;

        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        async function apiRequest(method, endpoint, body = null) {
            const res = await fetch(endpoint, {
                method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: body ? JSON.stringify(body) : null
            });
            if (!res.ok) throw new Error((await res.json()).error || 'Error');
            return res.json();
        }

        let importedRows = [];
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const wb = XLSX.read(ev.target.result, { type: file.name.endsWith('.csv') ? 'string' : 'array' });
                importedRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: true });
                renderPreview();
                document.getElementById('importBtn').disabled = false;
            };
            if (file.name.endsWith('.csv')) reader.readAsText(file);
            else reader.readAsArrayBuffer(file);
        }

        function renderPreview() {
            if (!importedRows.length) return;
            const headers = Object.keys(importedRows[0]);
            document.getElementById('previewHead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            document.getElementById('previewBody').innerHTML = importedRows.map(row => 
                `<tr>${headers.map(h => `<td>${row[h]||''}</td>`).join('')}</tr>`
            ).join('');
        }

        async function importToAccounts() {
            const rows = importedRows.map(row => ({
                date: row.Date || row['Txn Date'] || '',
                description: row.Narration || row.Description || 'Bank Import',
                amount: parseFloat(row.Debit || row.Credit || row.Amount || 0),
                type: (row.Debit && parseFloat(row.Debit) > 0) ? 'debit' : 'credit'
            })).filter(r => r.amount > 0 && r.date);

            await apiRequest('POST', '/api/transactions/bulk', { rows });
            alert(`Imported ${rows.length} transactions!`);
            document.getElementById('bankFile').value = '';
            importedRows = [];
            document.getElementById('previewHead').innerHTML = '';
            document.getElementById('previewBody').innerHTML = '';
            document.getElementById('importBtn').disabled = true;
        }
    </script>
</body>
</html>