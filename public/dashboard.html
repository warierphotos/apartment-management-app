<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Apartment Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">Apartment Mgmt</a>
            <div class="navbar-nav ms-auto">
                <span id="userInfo" class="nav-link text-light"></span>
                <a href="#" onclick="logout()" class="nav-link text-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Dashboard & Consolidation</h2>
        <div class="row g-3" id="statsRow"></div>

        <div class="mt-5">
            <h4>Quick Links</h4>
            <div class="list-group">
                <a href="apartments.html" class="list-group-item list-group-item-action">Apartments</a>
                <a href="owners.html" class="list-group-item list-group-item-action">Owners</a>
                <a href="tenants.html" class="list-group-item list-group-item-action">Tenants</a>
                <a href="maintenance.html" class="list-group-item list-group-item-action">Maintenance Payments</a>
                <a href="accounts.html" class="list-group-item list-group-item-action">Accounts Entries</a>
                <a href="import-bank.html" class="list-group-item list-group-item-action">Import Bank Statements</a>
                <a href="reports.html" class="list-group-item list-group-item-action">Reports</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        document.getElementById('userInfo').textContent = 
            `${sessionStorage.getItem('username')} (${sessionStorage.getItem('role')})`;

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        async function apiRequest(method, endpoint, body = null) {
            const res = await fetch(endpoint, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: body ? JSON.stringify(body) : null
            });
            if (!res.ok) throw new Error((await res.json()).error || 'API Error');
            return res.json();
        }

        async function loadStats() {
            const [apts, tenants, maint, txns] = await Promise.all([
                apiRequest('GET', '/api/apartments'),
                apiRequest('GET', '/api/tenants'),
                apiRequest('GET', '/api/maintenance_payments'),
                apiRequest('GET', '/api/transactions')
            ]);

            const occupied = apts.filter(a => a.status === 'occupied').length;
            const totalDue = maint.reduce((sum, p) => sum + (parseFloat(p.amount_due) - parseFloat(p.amount_paid || 0)), 0);
            const collected = maint.reduce((sum, p) => sum + parseFloat(p.amount_paid || 0), 0);
            const bankBalance = txns.reduce((sum, t) => sum + (t.type === 'credit' ? parseFloat(t.amount) : -parseFloat(t.amount)), 0);

            const html = `
                <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${apts.length}</h5><p class="text-muted">Total Apartments</p></div></div></div>
                <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${occupied}/${apts.length}</h5><p class="text-muted">Occupied</p></div></div></div>
                <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>₹${totalDue.toLocaleString('en-IN')}</h5><p class="text-muted">Maintenance Due</p></div></div></div>
                <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>₹${collected.toLocaleString('en-IN')}</h5><p class="text-muted">Collected</p></div></div></div>
                <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>₹${bankBalance.toLocaleString('en-IN')}</h5><p class="text-muted">Bank Balance</p></div></div></div>
                <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${tenants.length}</h5><p class="text-muted">Tenants</p></div></div></div>
            `;
            document.getElementById('statsRow').innerHTML = html;
        }

        window.onload = loadStats;
    </script>
</body>
</html>