<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Apartment Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Navbar same -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">Apartment Mgmt</a>
            <div class="navbar-nav ms-auto">
                <span id="userInfo" class="nav-link text-light"></span>
                <a href="#" onclick="logout()" class="nav-link text-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Reports</h2>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label>Report Type</label>
                <select id="reportType" class="form-select">
                    <option value="owner-list">Owner List</option>
                    <option value="tenant-list">Tenant List</option>
                    <option value="accounts-list">Accounts Entry List</option>
                    <option value="general-ledger">General Ledger</option>
                    <option value="balance-sheet">Balance Sheet</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button onclick="generateReport()" class="btn btn-primary w-100">Generate</button>
            </div>
        </div>

        <div id="reportContainer">
            <table class="table table-striped" id="reportTable">
                <thead id="reportHead"></thead>
                <tbody id="reportBody"></tbody>
            </table>
        </div>

        <div id="exportSection" class="mt-4" style="display:none;">
            <button onclick="exportCSV()" class="btn btn-outline-primary me-2">CSV</button>
            <button onclick="exportExcel()" class="btn btn-outline-success me-2">Excel</button>
            <button onclick="exportPDF()" class="btn btn-outline-danger">PDF</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'login.html';
        document.getElementById('userInfo').textContent = `${sessionStorage.getItem('username')} (${sessionStorage.getItem('role')})`;

        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        async function apiRequest(method, endpoint, body = null) {
            const res = await fetch(endpoint, {
                method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: body ? JSON.stringify(body) : null
            });
            if (!res.ok) throw new Error((await res.json()).error || 'Error');
            return res.json();
        }

        let currentData = [];
        let currentTitle = '';

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            currentTitle = document.getElementById('reportType').selectedOptions[0].text;

            let data = [];
            if (type === 'owner-list') data = await apiRequest('GET', '/api/owners');
            else if (type === 'tenant-list') data = await apiRequest('GET', '/api/tenants');
            else if (type === 'accounts-list') data = await apiRequest('GET', '/api/transactions');
            else if (type === 'general-ledger') {
                data = await apiRequest('GET', '/api/transactions');
                data.sort((a,b) => new Date(a.date) - new Date(b.date));
                let balance = 0;
                data = data.map(t => {
                    balance += t.type === 'credit' ? parseFloat(t.amount) : -parseFloat(t.amount);
                    return {...t, running_balance: balance.toFixed(2)};
                });
            }
            else if (type === 'balance-sheet') {
                const bs = await apiRequest('GET', '/api/reports/balance-sheet');
                data = [
                    {Item: 'Bank Balance', Amount: bs.assets.bankBalance},
                    {Item: 'Maintenance Receivable', Amount: bs.assets.maintenanceReceivable},
                    {Item: 'Total Assets', Amount: bs.totalAssets}
                ];
            }

            currentData = data;
            renderReport(data);
            document.getElementById('exportSection').style.display = 'block';
        }

        function renderReport(data) {
            if (!data.length) {
                document.getElementById('reportBody').innerHTML = '<tr><td colspan="10" class="text-center">No data</td></tr>';
                return;
            }
            const headers = Object.keys(data[0]);
            document.getElementById('reportHead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            document.getElementById('reportBody').innerHTML = data.map(row => 
                `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`
            ).join('');
        }

        function exportCSV() {
            if (!currentData.length) return;
            let csv = Object.keys(currentData[0]).join(',') + '\n' + currentData.map(row => Object.values(row).map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentTitle.replace(/ /g, '_') + '.csv';
            a.click();
        }

        function exportExcel() {
            if (!currentData.length) return;
            const ws = XLSX.utils.json_to_sheet(currentData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, currentTitle);
            XLSX.writeFile(wb, currentTitle.replace(/ /g, '_') + '.xlsx');
        }

        function exportPDF() {
            if (!currentData.length) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(currentTitle, 14, 20);
            doc.autoTable({
                head: [Object.keys(currentData[0])],
                body: currentData.map(row => Object.values(row)),
                startY: 30
            });
            doc.save(currentTitle.replace(/ /g, '_') + '.pdf');
        }
    </script>
</body>
</html>