<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Exports - Apartment Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">Apartment Mgmt</a>
            <div class="navbar-nav ms-auto">
                <span id="userInfo" class="nav-link text-light"></span>
                <a href="#" onclick="logout()" class="nav-link text-light">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Reports & Exports</h2>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="form-label">Report Type</label>
                <select id="reportType" class="form-select">
                    <option value="ledger">Account Ledger</option>
                    <option value="maintenance">Maintenance Collection Report</option>
                    <option value="defaulters">Defaulters List</option>
                    <option value="tenants">Tenant List</option>
                    <option value="owners">Owner List</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" id="dateFrom" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" id="dateTo" class="form-control">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button onclick="generateReport()" class="btn btn-primary w-100">Generate Report</button>
            </div>
        </div>

        <div id="reportContainer">
            <table class="table table-striped" id="reportTable">
                <thead><tr id="reportHead"></tr></thead>
                <tbody id="reportBody"></tbody>
            </table>
        </div>

        <div id="exportSection" class="mt-4" style="display:none;">
            <h5>Export Current Report</h5>
            <button onclick="exportCSV()" class="btn btn-outline-primary me-2">CSV</button>
            <button onclick="exportExcel()" class="btn btn-outline-success me-2">Excel</button>
            <button onclick="exportPDF()" class="btn btn-outline-danger">PDF</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentReportData = [];
        let currentReportTitle = '';

        function checkAuth() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!user) window.location.href = 'login.html';
            document.getElementById('userInfo').textContent = `${user.username} (${user.role})`;
        }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        function getData(key) { return JSON.parse(localStorage.getItem(key)) || []; }

        function getApartmentById(id) {
            const apts = getData('apartments');
            return apts.find(a => a.id == id) || {number: 'N/A'};
        }

        function generateReport() {
            const type = document.getElementById('reportType').value;
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;

            let data = [];
            let title = '';

            switch(type) {
                case 'ledger':
                    data = getData('transactions');
                    if (from || to) {
                        data = data.filter(t => {
                            const tdate = new Date(t.date);
                            const f = from ? new Date(from) : null;
                            const tt = to ? new Date(to) : null;
                            return (!f || tdate >= f) && (!tt || tdate <= tt);
                        });
                    }
                    title = 'Account Ledger';
                    break;

                case 'maintenance':
                    data = getData('maintenancePayments').map(p => {
                        const apt = getApartmentById(p.apartmentId);
                        return {
                            Apartment: apt.number,
                            Month: p.month,
                            AmountDue: p.amountDue,
                            AmountPaid: p.amountPaid || 0,
                            Status: p.status
                        };
                    });
                    title = 'Maintenance Collection Report';
                    break;

                case 'defaulters':
                    data = getData('maintenancePayments')
                        .filter(p => p.status === 'pending' && parseFloat(p.amountDue || 0) > parseFloat(p.amountPaid || 0))
                        .map(p => {
                            const apt = getApartmentById(p.apartmentId);
                            return {
                                Apartment: apt.number,
                                Month: p.month,
                                Due: p.amountDue,
                                Paid: p.amountPaid || 0,
                                Balance: (parseFloat(p.amountDue || 0) - parseFloat(p.amountPaid || 0)).toFixed(2)
                            };
                        });
                    title = 'Defaulters List';
                    break;

                case 'tenants':
                    data = getData('tenants').map(t => {
                        const apt = getApartmentById(t.apartmentId);
                        return {
                            TenantName: t.name,
                            Phone: t.phone,
                            Email: t.email,
                            Apartment: apt.number,
                            Rent: t.rentAmount,
                            MoveIn: t.moveInDate
                        };
                    });
                    title = 'Tenant List';
                    break;

                case 'owners':
                    data = getData('owners').map(o => {
                        const apt = getApartmentById(o.linkedApartmentId);
                        return {
                            OwnerName: o.name,
                            Phone: o.phone,
                            Email: o.email,
                            Apartment: apt.number
                        };
                    });
                    title = 'Owner List';
                    break;
            }

            currentReportData = data;
            currentReportTitle = title;
            renderReportTable(data, title);
            document.getElementById('exportSection').style.display = data.length ? 'block' : 'none';
        }

        function renderReportTable(data, title) {
            if (!data.length) {
                document.getElementById('reportHead').innerHTML = '';
                document.getElementById('reportBody').innerHTML = `<tr><td colspan="10" class="text-center text-muted">No data found for this report.</td></tr>`;
                return;
            }

            const headers = Object.keys(data[0]);
            let headHTML = `<th>#</th>`;
            headers.forEach(h => headHTML += `<th>${h}</th>`);
            document.getElementById('reportHead').innerHTML = headHTML;

            let bodyHTML = '';
            data.forEach((row, index) => {
                let rowHTML = `<tr><td>${index+1}</td>`;
                headers.forEach(h => {
                    rowHTML += `<td>${row[h]}</td>`;
                });
                rowHTML += '</tr>';
                bodyHTML += rowHTML;
            });
            document.getElementById('reportBody').innerHTML = bodyHTML;
        }

        // Export Functions
        function exportCSV() {
            if (!currentReportData.length) return;
            let csvContent = Object.keys(currentReportData[0]).join(',') + '\n';
            currentReportData.forEach(row => {
                csvContent += Object.values(row).map(val => `"${val}"`).join(',') + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentReportTitle.replace(/ /g, '_')}.csv`;
            link.click();
        }

        function exportExcel() {
            if (!currentReportData.length) return;
            const ws = XLSX.utils.json_to_sheet(currentReportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, currentReportTitle);
            XLSX.writeFile(wb, `${currentReportTitle.replace(/ /g, '_')}.xlsx`);
        }

        function exportPDF() {
            if (!currentReportData.length) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(currentReportTitle, 14, 20);

            const headers = Object.keys(currentReportData[0]);
            const body = currentReportData.map(row => Object.values(row));

            doc.autoTable({
                head: [headers],
                body: body,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 9 }
            });

            doc.save(`${currentReportTitle.replace(/ /g, '_')}.pdf`);
        }

        window.onload = () => {
            checkAuth();
            // Auto-generate default ledger on load
            setTimeout(() => generateReport(), 300);
        };
    </script>
</body>
</html>